---
title: "Análisis de Picks de Fútbol - Julio 2024"
author: "Tu Nombre"
date: "`r Sys.Date()`"
output: 
  html_document:
    toc: true
    toc_float: true
    code_folding: show
  github_document:
    toc: true
    toc_depth: 3
    html_preview: false
---

# Análisis de Puntos Mensuales

## 1. Cargar Paquetes Necesarios

```{r setup, message=FALSE, warning=FALSE}
# "if (!require("pacman"))" pregunta si el paquete "pacman" está instalado; si no lo está, lo instala con install.packages("pacman").
# Luego, "pacman::p_load(...)" carga varios paquetes necesarios para el análisis y la visualización de datos en R.
if (!require("pacman")) install.packages("pacman")
pacman::p_load(here, dplyr, ggplot2, httpgd, tidyr, readr, lubridate, purrr, rlang, ggthemes)
options(stringsAsFactors = FALSE)
```

## 2. Importar Datos

```{r import-data}
# URL y lectura de datos
# Ir a la dirección web, descargar el archivo CSV y cargarlo en un data frame llamado "acumulado".
url <- "https://raw.githubusercontent.com/Joaquin-Barrera-Flores/Football-picks-analytics/main/data/raw/acumulados_mensuales/2024/marzo_2024.csv"
acumulado <- read.csv(url)

# Vista previa
message("Vista previa de los datos:")
glimpse(acumulado)
```

## 3. PREPARACIÓN DE DATOS

```{r prepare-data}
# Convertir fechas al formato adecuado para R de acuerdo a la configuración original del dataset
acumulado$marzo <- dmy(acumulado$marzo)

# Mostrar estructura final
message("Datos después de convertir fechas:")
str(acumulado)
```

## 4. CONFIGURACIÓN

```{r config}
# Nombres de jugadores
# Creación de una lista de jugadores con su nombre como parcialmente viene en el dataset: "puntos_nombre".
jugadores <- c("barrera", "chochos", "dani", "velez")
glimpse(jugadores)
```

```{r display-names}
# Nombres para mostrar
# Crear un vector de nombres como se mostrarán en la gráfica.
nombres_jugadores <- c("barrera" = "Barrera", "chochos" = "Chochos", "dani" = "Dani", "velez" = "Vélez")
glimpse(nombres_jugadores)
```

```{r colors}
# Crear un vector de colores asignados para cada jugador.
colores <- c(
    "Barrera" = "#49525e",
    "Chochos" = "#9b93c9",
    "Dani" = "#fdb052",
    "Vélez" = "#59acbe"
)
```

```{r text-adjustments}
# Ajustes individuales para la posición del texto de cada jugador en la gráfica. Se ubican como "documentos" contenidos en "cartpetas".
# OJO: Estos ajustes se realizarón una vez hecho un primer gráfico y ver dónde se sobreponían los textos.
# Se colocarón en esta ubicación para tener todo el código de configuración junto.
ajustes_texto <- list(
    barrera = list(desp_dias = 1, desp_pct = 0.01),
    chochos = list(desp_dias = 1, desp_pct = -0.02),
    dani    = list(desp_dias = 1, desp_pct = 0.04),
    velez   = list(desp_dias = 1, desp_pct = -0.03)
)
glimpse(ajustes_texto)
```

## 5. CALCULOS INTERMEDIOS

```{r max-value-calculation}
# Calcular los valores máximos de puntos para cada jugador y almacenarlos en una lista llamada "maximos".
# Uso de map() de purrr para expresar: "para cada jugador en la lista de jugadores, encuentra la fila en 'acumulado' donde el valor de puntos es máximo".
# map(lista, ~): "Para cada elemeto en la lista, ejecuta esta operación".
# ~ reemplaza la función anónima function(jugador).
# .x es cada elemento de la lista (cada jugador).
# 1. paste0("puntos_", .x): "Para cada jugador, crea el nombre de columna 'puntos_' + nombre_del_jugador"
# 2. acumulado[["puntos_.x"]]: "Busca y accede a la columna correspondiente en el data frame 'acumulado'".
# 3. which.max(...): "Encuentra el índice de la fila donde el valor es máximo".
# 4. acumulado[which.max(...), ]: "Extrae toda la fila correspondiente a ese índice".
# 5. Finalmente, names(maximos) <- jugadores asigna nombres a cada elemento de la lista "maximos" para facilitar su referencia posterior.

maximos <- map(jugadores, ~ acumulado[which.max(acumulado[[paste0("puntos_", .x)]]), ])
names(maximos) <- jugadores
glimpse(maximos)
```

```{r last-value-calculation} 
# Calcular los últimos valores de puntos para cada jugador y almacenarlos en una lista llamada "ultimos".
# Uso de map(lista, ~) para iterar sobre cada jugador.
# slice_tail(n = 1): "Selecciona la última fila del data frame 'acumulado'".
# all_of() sirve para seleccionar columnas de manera segura, especialmente cuando los nombres de las columnas se generan dinámicamente.
# Ventaja de all_of(): Si por error escribes "puntos_barera" (falta una 'r'), te dará error inmediato en lugar de crear una columna llena de NA.
# select(julio, puntos = all_of(paste0("puntos_", .x))): "Selecciona la columna 'julio' y la columna de puntos correspondiente al jugador actual, renombrándola como 'puntos_.x'".
# Facilita el uso de una sola regla en lugar de repetir el código para cada jugador en la ubicación de los puntos dentrod e la gráfica.

ultimos <- map(jugadores, ~ acumulado %>% # Itera sobre cada jugador; usa el data frame "acumulado"
    slice_tail(n = 1) %>% # Selecciona la última fila
    select(marzo, puntos = all_of(paste0("puntos_", .x)))) # Seleccuiona la columna fecha y la columna puntos del jugador actual.
names(ultimos) <- jugadores # Asigna como nombre el nombre del jugador para cada elemento dentro de la lista "últimos".
glimpse(ultimos)
```

## 6. CONSTRUCCIÓN DE POSICIONES DE TEXTO AJUSTADAS

```{r adjusted-text-position}
# Construcción de un data frame con las posiciones de texto ajustadas individualmente para cada jugador.
# Uso de map() para iterar sobre cada jugador y aplicar los ajustes específicos definidos en "ajustes_texto".
# Se ajusta el eje horizontal usando la referencia de la fecha(fecha_texto), la altura del texto(y_texto), el texto de la leyenda (jugador) y la etiqueta dentro del gráfico (label).
# Para ello se necesitan las siguientes referencias:
# fila: La fila del data frame "maximos" correspondiente al jugador actual.
# puntos_col: El nombre de la columna de puntos para el jugador actual.
# desp: Los ajustes específicos de desplazamiento para el jugador actual.
# rango_y: Es el tope y el fondo del eje y, para calcular el desplazamiento vertical relativo.

maximos_ajustados <- map(jugadores, ~ {
    maximo <- maximos[[.x]] # Se obtiene el MAXIMO individual del jugador de la iteración actual.
    puntos_jugador <- paste0("puntos_", .x) # NOMBRE (en texto) de la columna de puntos del jugador actual.
    desp <- ajustes_texto[[.x]] # Valores individuales de desplazamiento.
    rango_y <- diff(range(acumulado[[puntos_jugador]])) # Rango de posibilidad de ubicación para el valor en el eje Y para cada jugador.

    data.frame(
        ajuste_x = maximo$marzo + days(desp$desp_dias), # Ajuste horizontal: Se usa la fecha sumada al desplazamiento .
        ajuste_y = maximo[[puntos_jugador]] + (rango_y * desp$desp_pct), # Ajuste vertical: Se usa el valor de puntos (busacdo con el nombre de la columna del jugador) mas el desplazamiento dado por el rango multiplicado por el porcentaje de desplazamiento.
        jugador = nombres_jugadores[[.x]], # Nombre para mostrar en la leyenda. Se usa el diccionario para traducir el nombre del jugadore desde "jugadores".
        etiqueta = maximo[[puntos_jugador]] # Valor de la etiqueta (número de puntos) que se mostrará en el gráfico.
    )
}) %>% bind_rows() # Combina todas las listas individuales en un solo data frame.

glimpse(maximos_ajustados) # nolint
```

## 7. VISUALIZACIÓN

```{r start-graphic-device}
## Iniciar el servidor de gráficos emn el navegador
# hgd()

## Abre la ventana del navegador para ver los gráficos
# hgd_browse()
```

```{r plot}
# Crear gráfico
# "Gráfico donde el eje x son las fechas de julio"
mar_24 <- ggplot(acumulado, aes(x = marzo)) +
    # Lineas para cada jugador
    # Eje Y, colores, anchura de línea
    map(jugadores, ~ {
        geom_line(
            aes(
                y = !!sym(paste0("puntos_", .x)),
                color = nombres_jugadores[[.x]]
            ),
            linewidth = 0.35
        )
    }) +

    # Puntos finales para cada jugador
    map(jugadores, ~ {
        geom_point(
            data = ultimos[[.x]],
            aes(
                x = marzo,
                y = puntos,
                color = nombres_jugadores[[.x]]
            ), # nolint
            size = 0.7,
            show.legend = FALSE # nolint
        ) # Nolint
    }) +

    # Texto con máximos
    geom_text(
        data = maximos_ajustados,
        aes(x = ajuste_x, y = ajuste_y, label = etiqueta, color = jugador),
        size = 4,
        show.legend = FALSE
    ) +

    # Formato de etiquetas
    labs(
        title = "Tabla mensual - Marzo",
        caption = "Datos a 31 de marzo de 2024",
        x = "Dias",
        y = "Puntos",
        color = "Jugador"
    ) +
    
    # Formato de ejes 
    scale_x_date(breaks = "1 week", date_labels = "%d") + # ← "Marca cada semana en X y muestra solo el día (número)"
    scale_color_manual(values = colores) + # Usa el vector de colores definido en la Configuración
    theme_few()

# Mostrar gráfico
    print(mar_24)
```

```{r save-graphics}
#Guardar gráfico
#ggsave(
#    filename = "outputs/plots/Phase 1/r/progresiones/mensuales/r_tabla_marzo_2024.png",
#    plot = mar_24,
#    width = 16,
#    height = 8,
#    units = "in",
#    dpi = 600
#)
```